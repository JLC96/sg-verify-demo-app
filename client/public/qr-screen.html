<!DOCTYPE html>
<html>

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <link href="https://fonts.googleapis.com/css?family=Lato:300,300i,400,400i,700,700i" rel="stylesheet">
  <link href="assets/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/jquery-ui/css/jquery-ui.min.css" rel="stylesheet">
  <link href="assets/vendor/jquery-ui-sliderbutton/css/jquery.ui.sliderbutton.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="assets/css/style.css">

  <title>Sample Visitor Management System Screen</title>
  <meta name="keywords" content="" />
  <meta name="author" content="Royce Cheng" />
</head>

<body style="background-color:#0b9be0;">
    <div id="sample-header" class="pl-4">
        <strong class="f-20">SAMPLE APP FOR QR IDENTITY - VISITOR MANAGEMENT EXAMPLE</strong><br>
        1. To begin, click the SingPass Mobile (TEST) app on the right.<br>
        2. Simulate consent on the SPM app on the right.<br>
        3. Current page will be updated with the profile.
    </div>

    <div id="sample-main" class="container-fluid">
      <div class="row" id="page1">
        <div class="col-sm-12 welcome-header">
            <h1>Self-Registration Counter</h1>
        </div>
        <div class="col-sm-12 welcome-category">
            <p>I am <span>a visitor <i class="fa fa-caret-down"></i></span></p>
            <img src="assets/images/qr-code.png">
        </div>
      </div>
      <div class="row" id="page2">
        <div class="col-sm-12 welcome-header">
            <h1>Self-Registration Counter</h1>
        </div>
        <div class="col-sm-12 welcome-category">
            <p>Welcome <span id="name"></span></p>
            <table class="welcome-details" style="margin-top: 50px;">
              <tr>
                <td style="padding-right: 20px;"><strong>Partial NRIC:</strong></td>
                <td id="partialuinfin"></td>
              </tr>
              <tr>
                <td style="padding-right: 20px;"><strong>Race:</strong></td>
                <td id="race"></td>
              </tr>
              <tr>
                <td style="padding-right: 20px;"><strong>Date of Birth:</strong></td>
                <td id="dob"></td>
              </tr>
              <tr>
                <td style="padding-right: 20px;"><strong>Mobile Number:</strong></td>
                <td id="mobileno"></td>
              </tr>
            </table>
        </div>
      </div>
    </div>
    <a class="restart-link" onclick="reset()" id="resetButton" style="colour: white">
        <span class="fa fa-undo"></span> RESTART
    </a>
    <script type="text/javascript" src="assets/vendor/jquery-3.4.1.min.js"></script>
    <script>
      window.onload = function(){
        $("#page2").hide();
        $("#resetButton").hide();

        // 'state' should be randomly generated and add to QR
        // This is just a demo, it is set in config.json
        var state;
        $.ajax({
            url: "http://localhost:3002/applicationstate",
            type: "GET",
            success: function(data) {
              alert(data);
              state = data;
            },
            fail: function(data){
              alert(data);
            },
            dataType: "json",
            timeout: 5000
        });

        (function poll() {
          setTimeout(function() {
              $.ajax({
                  url: "http://localhost:3002/getData?state="+state,
                  type: "GET",
                  success: function(data) {
                    $("#page1").hide();
                    $("#page2").show();
                    $("#resetButton").show();
                    populate(data);
                  },
                  dataType: "json",
                  complete: poll,
                  timeout: 5000
              })
          }, 5000);
        })();
      }

      function reset(){
        $("#page1").show();
        $("#page2").hide();
        $("#resetButton").hide();
        resetForm();
      }

      function populate(data){
        document.getElementById('name').innerHTML = data.name ? data.name.value : "";
        document.getElementById('partialuinfin').innerHTML = data.partialuinfin ? data.partialuinfin.value : "";
        document.getElementById('dob').innerHTML = data.dob ? formatDate(data.dob.value) : "";
        document.getElementById('race').innerHTML = data.race ? data.race.desc : "";
        document.getElementById('mobileno').innerHTML = data.mobileno ? data.mobileno.nbr.value : "";
      }

      function resetForm(){
        document.getElementById('name').innerHTML = "";
        document.getElementById('partialuinfin').innerHTML = "";
        document.getElementById('dob').innerHTML =  "";
        document.getElementById('race').innerHTML =  "";
        document.getElementById('mobileno').innerHTML =  "";
      }

      function formatDate(date) {
        var d = new Date(date);
        var monthNames = [
          "Jan", "Feb", "Mar",
          "Apr", "May", "Jun", "Jul",
          "Aug", "Sep", "Oct",
          "Nov", "Dec"
        ];

        var day = d.getDate();
        var monthIndex = d.getMonth();
        var year = d.getFullYear();

        return day + ' ' + monthNames[monthIndex] + ' ' + year;
      }
    </script>
</body>
